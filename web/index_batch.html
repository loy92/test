<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBRæè´¨è¯†åˆ«ç³»ç»Ÿ - æ”¯æŒæ‰¹é‡å¤„ç†</title>
    
    <!-- å¼•å…¥ Atomm UI æ ·å¼ -->
    <link rel="stylesheet" href="https://minio-download.makeblock.com/resource/atomm-ui-umd/dist-browser/atomm-ui.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .mode-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .mode-tabs {
            display: inline-flex;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 4px;
        }
        
        .mode-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .mode-tab.active {
            background: #1890ff;
            color: white;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .single-mode .main-content {
            grid-template-columns: 1fr 1fr;
        }
        
        .batch-mode .main-content {
            grid-template-columns: 1fr;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .batch-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .batch-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .batch-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .pbr-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .pbr-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .pbr-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .pbr-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .batch-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .batch-result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .batch-result-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px;
        }
        
        .result-data {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 12px;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .status-ok { background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status-warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin: 10px 0; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary { background: #1890ff; color: white; }
        .btn-success { background: #52c41a; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #fa8c16; color: white; }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ PBRæè´¨è¯†åˆ«ç³»ç»Ÿ</h1>
        <p>æ”¯æŒå•å¼ å’Œæ‰¹é‡å›¾ç‰‡çš„PBRå‚æ•°è¯†åˆ«</p>
    </div>
    
    <div class="container" id="app" :class="isBatchMode ? 'batch-mode' : 'single-mode'">
        <!-- æ¨¡å¼é€‰æ‹©å™¨ -->
        <div class="mode-selector">
            <div class="mode-tabs">
                <button class="mode-tab" 
                        :class="{ active: !isBatchMode }"
                        @click="switchMode(false)">
                    ğŸ“¸ å•å¼ è¯†åˆ«
                </button>
                <button class="mode-tab" 
                        :class="{ active: isBatchMode }"
                        @click="switchMode(true)">
                    ğŸ“š æ‰¹é‡è¯†åˆ«
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- å•å¼ æ¨¡å¼ -->
            <div v-if="!isBatchMode" class="panel">
                <h3>ğŸ“¸ å•å¼ å›¾ç‰‡è¯†åˆ«</h3>
                
                <div class="upload-area" @click="triggerSingleFileInput">
                    <div v-if="!selectedImage">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                        <h4>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</h4>
                        <p>æ”¯æŒ JPG, PNG, WebP æ ¼å¼</p>
                    </div>
                    
                    <div v-else>
                        <img :src="selectedImage" alt="é¢„è§ˆå›¾ç‰‡" class="image-preview">
                        <p>ç‚¹å‡»é‡æ–°é€‰æ‹©å›¾ç‰‡</p>
                    </div>
                </div>
                
                <input type="file" 
                       ref="singleFileInput" 
                       @change="handleSingleFileSelect"
                       accept="image/*" 
                       style="display: none;">
                
                <!-- å•å¼ çŠ¶æ€æ˜¾ç¤º -->
                <div style="margin-top: 20px;">
                    <div :class="isAnalyzing ? 'status-warning' : 'status-ok'">
                        <strong>åˆ†æçŠ¶æ€:</strong> {{ isAnalyzing ? 'ğŸ”„ åˆ†æä¸­...' : 'âœ… å°±ç»ª' }}
                    </div>
                    
                    <div v-if="selectedImage" style="margin-top: 15px;">
                        <button @click="startSingleAnalysis" 
                                :disabled="isAnalyzing"
                                class="btn btn-primary"
                                style="width: 100%;">
                            {{ isAnalyzing ? 'ğŸ”„ åˆ†æä¸­ï¼Œè¯·ç¨å€™...' : 'ğŸ” å¼€å§‹åˆ†ææè´¨' }}
                        </button>
                    </div>
                    
                    <button @click="forceReset" class="btn btn-danger" style="width: 100%;">
                        ğŸš¨ å¼ºåˆ¶é‡ç½®çŠ¶æ€
                    </button>
                </div>
            </div>

            <!-- æ‰¹é‡æ¨¡å¼ -->
            <div v-if="isBatchMode" class="panel">
                <h3>ğŸ“š æ‰¹é‡å›¾ç‰‡è¯†åˆ«</h3>
                
                <div class="upload-area" @click="triggerBatchFileInput">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                    <h4>ç‚¹å‡»é€‰æ‹©å¤šå¼ å›¾ç‰‡</h4>
                    <p>æ”¯æŒ JPG, PNG, WebP æ ¼å¼ï¼Œå¯åŒæ—¶é€‰æ‹©å¤šå¼ </p>
                </div>
                
                <input type="file" 
                       ref="batchFileInput" 
                       @change="handleBatchFileSelect"
                       accept="image/*" 
                       multiple
                       style="display: none;">
                
                <!-- æ‰¹é‡å›¾ç‰‡é¢„è§ˆ -->
                <div v-if="selectedImages.length > 0">
                    <h4>å·²é€‰æ‹©å›¾ç‰‡ ({{ selectedImages.length }}å¼ )</h4>
                    <div class="batch-grid">
                        <div v-for="(image, index) in selectedImages" :key="index" class="batch-item">
                            <img :src="image.preview" :alt="image.name">
                            <button class="remove-btn" @click="removeImage(index)">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button @click="startBatchAnalysis" 
                                :disabled="isBatchAnalyzing"
                                class="btn btn-primary">
                            {{ isBatchAnalyzing ? `ğŸ”„ åˆ†æä¸­ (${batchProgress}/${selectedImages.length})` : 'ğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ' }}
                        </button>
                        
                        <button @click="clearAllImages" 
                                :disabled="isBatchAnalyzing"
                                class="btn btn-warning">
                            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
                        </button>
                        
                        <button v-if="batchResults.length > 0"
                                @click="exportBatchResults" 
                                class="btn btn-success">
                            ğŸ“Š å¯¼å‡ºç»“æœ
                        </button>
                    </div>
                    
                    <!-- æ‰¹é‡è¿›åº¦ -->
                    <div v-if="isBatchAnalyzing" class="status-warning">
                        <strong>æ‰¹é‡åˆ†æè¿›åº¦:</strong> {{ batchProgress }}/{{ selectedImages.length }} 
                        ({{ Math.round(batchProgress / selectedImages.length * 100) }}%)
                    </div>
                </div>
                
                <!-- æ‰¹é‡ç»“æœæ˜¾ç¤º -->
                <div v-if="batchResults.length > 0">
                    <h4>ğŸ“Š æ‰¹é‡åˆ†æç»“æœ ({{ batchResults.length }}å¼ )</h4>
                    <div class="batch-results">
                        <div v-for="(result, index) in batchResults" :key="index" class="batch-result-item">
                            <img :src="result.image" :alt="result.name">
                            <div class="result-data">
                                <div>
                                    <strong>é‡‘å±åº¦</strong><br>
                                    {{ (result.metallic * 100).toFixed(1) }}%
                                </div>
                                <div>
                                    <strong>ç²—ç³™åº¦</strong><br>
                                    {{ (result.roughness * 100).toFixed(1) }}%
                                </div>
                                <div>
                                    <strong>é€æ˜åº¦</strong><br>
                                    {{ (result.transparency * 100).toFixed(1) }}%
                                </div>
                                <div>
                                    <strong>ç½®ä¿¡åº¦</strong><br>
                                    {{ (result.confidence * 100).toFixed(1) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PBRå‚æ•°æ˜¾ç¤ºé¢æ¿ï¼ˆå•å¼ æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰ -->
            <div v-if="!isBatchMode" class="panel">
                <h3>âš™ï¸ PBRæè´¨å‚æ•°</h3>
                
                <div v-if="pbrResults" style="border: 2px solid #4CAF50; padding: 15px; border-radius: 8px; background: #f8fff8;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <p style="color: #4CAF50; font-weight: bold; margin: 0;">âœ… PBRå‚æ•°å·²è¯†åˆ«</p>
                        <small style="color: #666;">{{ new Date().toLocaleTimeString() }}</small>
                    </div>
                    
                    <div class="pbr-grid">
                        <div class="pbr-item">
                            <div class="pbr-label">é‡‘å±åº¦ (Metallic)</div>
                            <div class="pbr-value">{{ ((pbrResults.metallic || 0) * 100).toFixed(1) }}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" 
                                     :style="{ width: ((pbrResults.metallic || 0) * 100) + '%', background: '#52c41a' }">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pbr-item">
                            <div class="pbr-label">ç²—ç³™åº¦ (Roughness)</div>
                            <div class="pbr-value">{{ ((pbrResults.roughness || 0) * 100).toFixed(1) }}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" 
                                     :style="{ width: ((pbrResults.roughness || 0) * 100) + '%', background: '#1890ff' }">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pbr-item">
                            <div class="pbr-label">é€æ˜åº¦ (Transparency)</div>
                            <div class="pbr-value">{{ ((pbrResults.transparency || 0) * 100).toFixed(1) }}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" 
                                     :style="{ width: ((pbrResults.transparency || 0) * 100) + '%', background: '#fa8c16' }">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pbr-item">
                            <div class="pbr-label">ç½®ä¿¡åº¦ (Confidence)</div>
                            <div class="pbr-value">{{ ((pbrResults.confidence || 0) * 100).toFixed(1) }}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" 
                                     :style="{ width: ((pbrResults.confidence || 0) * 100) + '%', background: '#eb2f96' }">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; padding: 12px; background: rgba(24, 144, 255, 0.1); border-radius: 8px;">
                        <p style="margin: 0; color: #1890ff; font-weight: 500;">
                            ğŸ¨ é¢„æµ‹æè´¨ç±»å‹: {{ pbrResults.material_type || 'æŠ›å…‰é‡‘å±' }}
                        </p>
                    </div>
                </div>
                
                <div v-else style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 1.1rem;">
                        ğŸ¯ ä¸Šä¼ å›¾ç‰‡å¼€å§‹åˆ†æ
                    </div>
                    <p style="margin-top: 8px;">
                        AIå°†è‡ªåŠ¨è¯†åˆ«æè´¨çš„ç‰©ç†å±æ€§
                    </p>
                </div>
                
                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div class="debug-info">
                    <h4>ğŸ” è°ƒè¯•ä¿¡æ¯</h4>
                    <p><strong>æ¨¡å¼:</strong> {{ isBatchMode ? 'æ‰¹é‡æ¨¡å¼' : 'å•å¼ æ¨¡å¼' }}</p>
                    <p><strong>isAnalyzing:</strong> {{ isAnalyzing }}</p>
                    <p><strong>isBatchAnalyzing:</strong> {{ isBatchAnalyzing }}</p>
                    <p><strong>selectedImage:</strong> {{ selectedImage ? 'exists' : 'null' }}</p>
                    <p><strong>selectedImages:</strong> {{ selectedImages.length }}</p>
                    <p><strong>pbrResults:</strong> {{ pbrResults ? 'exists' : 'null' }}</p>
                    <p><strong>batchResults:</strong> {{ batchResults.length }}</p>
                    <p><strong>ç»„ä»¶æŒ‚è½½:</strong> {{ mounted ? 'yes' : 'no' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // æ ¸å¿ƒçŠ¶æ€ - æ˜ç¡®åˆå§‹åŒ–
                    isAnalyzing: false,           // å•å¼ åˆ†æçŠ¶æ€
                    selectedImage: null,          // é€‰ä¸­çš„å›¾ç‰‡
                    pbrResults: null,             // å•å¼ PBRç»“æœ
                    mounted: false,               // æŒ‚è½½çŠ¶æ€
                    
                    // æ‰¹é‡å¤„ç†çŠ¶æ€
                    isBatchMode: false,           // æ‰¹é‡æ¨¡å¼
                    isBatchAnalyzing: false,      // æ‰¹é‡åˆ†æçŠ¶æ€
                    selectedImages: [],           // æ‰¹é‡é€‰æ‹©çš„å›¾ç‰‡
                    batchProgress: 0,             // æ‰¹é‡è¿›åº¦
                    batchResults: []              // æ‰¹é‡ç»“æœ
                };
            },
            
            methods: {
                // åˆ‡æ¢æ¨¡å¼
                switchMode(batchMode) {
                    this.isBatchMode = batchMode;
                    this.forceReset();
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°', batchMode ? 'æ‰¹é‡æ¨¡å¼' : 'å•å¼ æ¨¡å¼');
                },
                
                // è§¦å‘å•å¼ æ–‡ä»¶é€‰æ‹©
                triggerSingleFileInput() {
                    this.$refs.singleFileInput.click();
                },
                
                // è§¦å‘æ‰¹é‡æ–‡ä»¶é€‰æ‹©
                triggerBatchFileInput() {
                    this.$refs.batchFileInput.click();
                },
                
                // å¤„ç†å•å¼ æ–‡ä»¶é€‰æ‹©
                handleSingleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.selectedImage = e.target.result;
                            console.log('âœ… å•å¼ å›¾ç‰‡å·²é€‰æ‹©');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                    }
                },
                
                // å¤„ç†æ‰¹é‡æ–‡ä»¶é€‰æ‹©
                handleBatchFileSelect(event) {
                    const files = Array.from(event.target.files);
                    
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.selectedImages.push({
                                    name: file.name,
                                    file: file,
                                    preview: e.target.result
                                });
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    
                    console.log(`âœ… æ‰¹é‡é€‰æ‹©äº† ${files.length} å¼ å›¾ç‰‡`);
                },
                
                // ç§»é™¤å•å¼ å›¾ç‰‡
                removeImage(index) {
                    this.selectedImages.splice(index, 1);
                    console.log(`ğŸ—‘ï¸ ç§»é™¤äº†ç¬¬ ${index + 1} å¼ å›¾ç‰‡`);
                },
                
                // æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
                clearAllImages() {
                    this.selectedImages = [];
                    this.batchResults = [];
                    this.batchProgress = 0;
                    console.log('ğŸ—‘ï¸ æ¸…ç©ºäº†æ‰€æœ‰å›¾ç‰‡');
                },
                
                // å¼€å§‹å•å¼ åˆ†æ
                async startSingleAnalysis() {
                    if (!this.selectedImage) {
                        alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                        return;
                    }
                    
                    console.log('ğŸ”„ å¼€å§‹å•å¼ åˆ†æï¼Œè®¾ç½®isAnalyzing = true');
                    this.isAnalyzing = true;
                    
                    try {
                        // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // æ¨¡æ‹ŸæˆåŠŸç»“æœ
                        const mockResult = {
                            metallic: Math.random() * 0.8 + 0.1,
                            roughness: Math.random() * 0.6 + 0.2,
                            transparency: Math.random() * 0.3,
                            confidence: Math.random() * 0.3 + 0.7,
                            material_type: ['æŠ›å…‰é‡‘å±', 'ç²—ç³™å¡‘æ–™', 'å…‰æ»‘ç»ç’ƒ', 'ç£¨ç ‚é‡‘å±'][Math.floor(Math.random() * 4)],
                            timestamp: new Date().toISOString()
                        };
                        
                        this.pbrResults = mockResult;
                        console.log('âœ… å•å¼ åˆ†æå®Œæˆï¼Œè®¾ç½®isAnalyzing = false');
                        
                    } catch (error) {
                        console.error('âŒ å•å¼ åˆ†æå‡ºé”™:', error);
                        alert('åˆ†æå¤±è´¥: ' + error.message);
                    } finally {
                        this.isAnalyzing = false;
                        console.log('ğŸ å•å¼ åˆ†æfinally: isAnalyzing = false');
                    }
                },
                
                // å¼€å§‹æ‰¹é‡åˆ†æ
                async startBatchAnalysis() {
                    if (this.selectedImages.length === 0) {
                        alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                        return;
                    }
                    
                    console.log(`ğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ ${this.selectedImages.length} å¼ å›¾ç‰‡`);
                    this.isBatchAnalyzing = true;
                    this.batchProgress = 0;
                    this.batchResults = [];
                    
                    try {
                        for (let i = 0; i < this.selectedImages.length; i++) {
                            const image = this.selectedImages[i];
                            console.log(`ğŸ”„ åˆ†æç¬¬ ${i + 1} å¼ å›¾ç‰‡: ${image.name}`);
                            
                            // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                            await new Promise(resolve => setTimeout(resolve, 1500));
                            
                            // æ¨¡æ‹Ÿåˆ†æç»“æœ
                            const result = {
                                name: image.name,
                                image: image.preview,
                                metallic: Math.random() * 0.8 + 0.1,
                                roughness: Math.random() * 0.6 + 0.2,
                                transparency: Math.random() * 0.3,
                                confidence: Math.random() * 0.3 + 0.7,
                                material_type: ['æŠ›å…‰é‡‘å±', 'ç²—ç³™å¡‘æ–™', 'å…‰æ»‘ç»ç’ƒ', 'ç£¨ç ‚é‡‘å±'][Math.floor(Math.random() * 4)],
                                timestamp: new Date().toISOString()
                            };
                            
                            this.batchResults.push(result);
                            this.batchProgress = i + 1;
                            
                            console.log(`âœ… ç¬¬ ${i + 1} å¼ å›¾ç‰‡åˆ†æå®Œæˆ`);
                        }
                        
                        console.log('ğŸ‰ æ‰¹é‡åˆ†æå…¨éƒ¨å®Œæˆï¼');
                        
                    } catch (error) {
                        console.error('âŒ æ‰¹é‡åˆ†æå‡ºé”™:', error);
                        alert('æ‰¹é‡åˆ†æå¤±è´¥: ' + error.message);
                    } finally {
                        this.isBatchAnalyzing = false;
                        console.log('ğŸ æ‰¹é‡åˆ†æfinally: isBatchAnalyzing = false');
                    }
                },
                
                // å¯¼å‡ºæ‰¹é‡ç»“æœ
                exportBatchResults() {
                    const results = this.batchResults.map(result => ({
                        å›¾ç‰‡åç§°: result.name,
                        é‡‘å±åº¦: (result.metallic * 100).toFixed(1) + '%',
                        ç²—ç³™åº¦: (result.roughness * 100).toFixed(1) + '%',
                        é€æ˜åº¦: (result.transparency * 100).toFixed(1) + '%',
                        ç½®ä¿¡åº¦: (result.confidence * 100).toFixed(1) + '%',
                        æè´¨ç±»å‹: result.material_type,
                        åˆ†ææ—¶é—´: result.timestamp
                    }));
                    
                    const csv = this.convertToCSV(results);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `PBRåˆ†æç»“æœ_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    
                    console.log('ğŸ“Š æ‰¹é‡ç»“æœå·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶');
                },
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                convertToCSV(data) {
                    if (data.length === 0) return '';
                    
                    const headers = Object.keys(data[0]);
                    const csv = [
                        headers.join(','),
                        ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
                    ].join('\n');
                    
                    return '\ufeff' + csv; // æ·»åŠ BOMä»¥ç¡®ä¿Excelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
                },
                
                // å¼ºåˆ¶é‡ç½®çŠ¶æ€
                forceReset() {
                    console.log('ğŸš¨ å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€');
                    this.isAnalyzing = false;
                    this.isBatchAnalyzing = false;
                    this.selectedImage = null;
                    this.selectedImages = [];
                    this.pbrResults = null;
                    this.batchResults = [];
                    this.batchProgress = 0;
                    alert('âœ… çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®ï¼');
                },
                
                // è‡ªåŠ¨åŠ è½½æµ‹è¯•æ•°æ®
                loadTestData() {
                    console.log('ğŸ“Š è‡ªåŠ¨åŠ è½½æµ‹è¯•æ•°æ®');
                    
                    // ç¡®ä¿ä¸å¤„äºåˆ†æçŠ¶æ€
                    this.isAnalyzing = false;
                    this.isBatchAnalyzing = false;
                    
                    const testData = {
                        metallic: 0.75,
                        roughness: 0.25,
                        transparency: 0.1,
                        confidence: 0.85,
                        material_type: 'æŠ›å…‰é‡‘å±',
                        timestamp: new Date().toISOString()
                    };
                    
                    this.pbrResults = testData;
                    console.log('âœ… æµ‹è¯•æ•°æ®åŠ è½½å®Œæˆ');
                }
            },
            
            // ç»„ä»¶æŒ‚è½½æ—¶
            mounted() {
                console.log('ğŸš€ Vueç»„ä»¶å·²æŒ‚è½½');
                this.mounted = true;
                
                // å¼ºåˆ¶ç¡®ä¿åˆ†æçŠ¶æ€ä¸ºfalse
                this.isAnalyzing = false;
                this.isBatchAnalyzing = false;
                
                // å»¶è¿Ÿè‡ªåŠ¨åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆä»…åœ¨å•å¼ æ¨¡å¼ï¼‰
                setTimeout(() => {
                    if (!this.isBatchMode) {
                        this.loadTestData();
                    }
                }, 1000);
                
                console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼ŒisAnalyzing =', this.isAnalyzing, ', isBatchAnalyzing =', this.isBatchAnalyzing);
            }
        }).mount('#app');
    </script>
</body>
</html>