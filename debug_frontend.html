<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBRå‚æ•°æ˜¾ç¤ºè°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .pbr-display {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .pbr-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ PBRå‚æ•°æ˜¾ç¤ºè°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºæµ‹è¯•å’Œè°ƒè¯•PBRæè´¨å‚æ•°çš„æ˜¾ç¤ºé—®é¢˜</p>

        <!-- APIè¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h3>
            <button class="button" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
            <div id="api-result" class="result" style="display: none;"></div>
        </div>

        <!-- PBRå‚æ•°æ˜¾ç¤ºæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ¯ PBRå‚æ•°æ˜¾ç¤ºæµ‹è¯•</h3>
            <button class="button" onclick="testPBRDisplay()">æ˜¾ç¤ºæµ‹è¯•å‚æ•°</button>
            <button class="button" onclick="clearPBRDisplay()">æ¸…é™¤æ˜¾ç¤º</button>
            
            <div id="pbr-display" style="display: none;">
                <div class="pbr-display">
                    <h4>PBRæè´¨å‚æ•°</h4>
                    <div class="pbr-item">
                        <span>é‡‘å±åº¦ (Metallic):</span>
                        <div>
                            <span id="metallic-value">0%</span>
                            <div class="progress-bar">
                                <div id="metallic-bar" class="progress-fill" style="background: #ffd700; width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pbr-item">
                        <span>ç²—ç³™åº¦ (Roughness):</span>
                        <div>
                            <span id="roughness-value">0%</span>
                            <div class="progress-bar">
                                <div id="roughness-bar" class="progress-fill" style="background: #cd853f; width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pbr-item">
                        <span>é€æ˜åº¦ (Transparency):</span>
                        <div>
                            <span id="transparency-value">0%</span>
                            <div class="progress-bar">
                                <div id="transparency-bar" class="progress-fill" style="background: #87ceeb; width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pbr-item">
                        <span>å‡¹å‡¸å¼ºåº¦ (Normal):</span>
                        <div>
                            <span id="normal-value">0%</span>
                            <div class="progress-bar">
                                <div id="normal-bar" class="progress-fill" style="background: #722ed1; width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pbr-item">
                        <span>ç½®ä¿¡åº¦:</span>
                        <span id="confidence-value">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®é™…APIæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª å®é™…APIåˆ†ææµ‹è¯•</h3>
            <p>ä½¿ç”¨ä¸€ä¸ªæµ‹è¯•å›¾åƒè°ƒç”¨çœŸå®çš„APIï¼š</p>
            <button class="button" onclick="testRealAnalysis()">æµ‹è¯•çœŸå®åˆ†æ</button>
            <div id="real-analysis-result" class="result" style="display: none;"></div>
        </div>

        <!-- è¯Šæ–­ä¿¡æ¯ -->
        <div class="test-section">
            <h3>ğŸ” ç³»ç»Ÿè¯Šæ–­</h3>
            <button class="button" onclick="runDiagnostics()">è¿è¡Œè¯Šæ–­</button>
            <div id="diagnostics-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        async function testAPIConnection() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';

            try {
                const response = await fetch('http://localhost:5001/');
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <strong>âœ… APIè¿æ¥æˆåŠŸ</strong><br>
                        çŠ¶æ€: ${data.status}<br>
                        è®¾å¤‡: ${data.device}<br>
                        ç‰ˆæœ¬: ${data.version}
                    `;
                } else {
                    resultDiv.innerHTML = 'âŒ APIè¿æ¥å¤±è´¥ï¼šå“åº”çŠ¶æ€ ' + response.status;
                }
            } catch (error) {
                resultDiv.innerHTML = 'âŒ APIè¿æ¥å¤±è´¥ï¼š' + error.message;
            }
        }

        function testPBRDisplay() {
            // æ˜¾ç¤ºæµ‹è¯•å‚æ•°
            const testData = {
                metallic: 0.75,
                roughness: 0.25,
                transparency: 0.1,
                normalStrength: 0.6,
                confidence: 0.85
            };

            updatePBRDisplay(testData);
            document.getElementById('pbr-display').style.display = 'block';
        }

        function clearPBRDisplay() {
            document.getElementById('pbr-display').style.display = 'none';
        }

        function updatePBRDisplay(data) {
            // æ›´æ–°æ•°å€¼æ˜¾ç¤º
            document.getElementById('metallic-value').textContent = (data.metallic * 100).toFixed(1) + '%';
            document.getElementById('roughness-value').textContent = (data.roughness * 100).toFixed(1) + '%';
            document.getElementById('transparency-value').textContent = (data.transparency * 100).toFixed(1) + '%';
            document.getElementById('normal-value').textContent = (data.normalStrength * 100).toFixed(1) + '%';
            document.getElementById('confidence-value').textContent = (data.confidence * 100).toFixed(1) + '%';

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('metallic-bar').style.width = (data.metallic * 100) + '%';
            document.getElementById('roughness-bar').style.width = (data.roughness * 100) + '%';
            document.getElementById('transparency-bar').style.width = (data.transparency * 100) + '%';
            document.getElementById('normal-bar').style.width = (data.normalStrength * 100) + '%';
        }

        async function testRealAnalysis() {
            const resultDiv = document.getElementById('real-analysis-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'æ­£åœ¨è°ƒç”¨APIè¿›è¡Œåˆ†æ...';

            // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾åƒï¼ˆ1x1åƒç´ çš„PNGï¼‰
            const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';

            try {
                const response = await fetch('http://localhost:5001/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: testImage,
                        settings: {}
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('APIå“åº”:', data);
                    
                    if (data.success && data.results) {
                        resultDiv.innerHTML = `
                            <strong>âœ… åˆ†ææˆåŠŸ</strong><br>
                            é‡‘å±åº¦: ${(data.results.metallic * 100).toFixed(1)}%<br>
                            ç²—ç³™åº¦: ${(data.results.roughness * 100).toFixed(1)}%<br>
                            é€æ˜åº¦: ${(data.results.transparency * 100).toFixed(1)}%<br>
                            å‡¹å‡¸å¼ºåº¦: ${(data.results.normalStrength * 100).toFixed(1)}%<br>
                            ç½®ä¿¡åº¦: ${(data.results.confidence * 100).toFixed(1)}%<br>
                            åŸºç¡€é¢œè‰²: [${data.results.base_color.join(', ')}]<br>
                            <br><strong>å®Œæ•´å“åº”:</strong><br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                        
                        // åœ¨PBRæ˜¾ç¤ºåŒºåŸŸæ˜¾ç¤ºç»“æœ
                        updatePBRDisplay(data.results);
                        document.getElementById('pbr-display').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = 'âŒ APIè¿”å›æ ¼å¼é”™è¯¯: ' + JSON.stringify(data);
                    }
                } else {
                    resultDiv.innerHTML = 'âŒ APIè¯·æ±‚å¤±è´¥ï¼šçŠ¶æ€ ' + response.status;
                }
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                resultDiv.innerHTML = 'âŒ åˆ†æå¤±è´¥ï¼š' + error.message;
            }
        }

        async function runDiagnostics() {
            const resultDiv = document.getElementById('diagnostics-result');
            resultDiv.style.display = 'block';
            
            let diagnostics = '<strong>ğŸ” ç³»ç»Ÿè¯Šæ–­ç»“æœ:</strong><br><br>';
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            diagnostics += '<strong>æµè§ˆå™¨æ”¯æŒ:</strong><br>';
            diagnostics += `User Agent: ${navigator.userAgent}<br>`;
            diagnostics += `Fetch API: ${typeof fetch !== 'undefined' ? 'âœ…' : 'âŒ'}<br>`;
            diagnostics += `JSONæ”¯æŒ: ${typeof JSON !== 'undefined' ? 'âœ…' : 'âŒ'}<br><br>`;
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            diagnostics += '<strong>ç½‘ç»œè¿æ¥:</strong><br>';
            try {
                const apiResponse = await fetch('http://localhost:5001/', { method: 'GET' });
                diagnostics += `APIæœåŠ¡å™¨ (5001): ${apiResponse.ok ? 'âœ… è¿æ¥æ­£å¸¸' : 'âŒ è¿æ¥å¤±è´¥'}<br>`;
            } catch (e) {
                diagnostics += `APIæœåŠ¡å™¨ (5001): âŒ è¿æ¥å¤±è´¥ (${e.message})<br>`;
            }
            
            try {
                const webResponse = await fetch('http://localhost:8081/', { method: 'GET' });
                diagnostics += `WebæœåŠ¡å™¨ (8081): ${webResponse.ok ? 'âœ… è¿æ¥æ­£å¸¸' : 'âŒ è¿æ¥å¤±è´¥'}<br>`;
            } catch (e) {
                diagnostics += `WebæœåŠ¡å™¨ (8081): âŒ è¿æ¥å¤±è´¥ (${e.message})<br>`;
            }
            
            // æ§åˆ¶å°é”™è¯¯æ£€æŸ¥
            diagnostics += '<br><strong>å»ºè®®:</strong><br>';
            diagnostics += '1. ç¡®ä¿APIæœåŠ¡å™¨åœ¨ç«¯å£5001è¿è¡Œ<br>';
            diagnostics += '2. ç¡®ä¿WebæœåŠ¡å™¨åœ¨ç«¯å£8081è¿è¡Œ<br>';
            diagnostics += '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯<br>';
            diagnostics += '4. å°è¯•åˆ·æ–°é¡µé¢<br>';
            
            resultDiv.innerHTML = diagnostics;
        }
    </script>
</body>
</html> 