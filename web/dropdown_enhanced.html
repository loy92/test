<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBR材质识别系统 - 下拉菜单版</title>
    
    <!-- 引入 Atomm UI 样式 -->
    <link rel="stylesheet" href="https://minio-download.makeblock.com/resource/atomm-ui-umd/dist-browser/atomm-ui.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .material-selection {
            margin-top: 20px;
        }
        
        .material-selection h4 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .dropdown-container {
            margin-bottom: 15px;
        }
        
        .dropdown-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .material-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .material-dropdown:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .material-dropdown:hover {
            border-color: #bdc3c7;
        }
        
        .results-panel {
            grid-column: 1 / -1;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .result-item h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .result-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .result-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #27ae60);
            transition: width 0.3s ease;
        }
        
        .confidence-high {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        
        .confidence-medium {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }
        
        .confidence-low {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .status.info {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .enhanced-features {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .enhanced-features h4 {
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            color: #2c3e50;
        }
        
        .feature-list li:before {
            content: "✓";
            color: #27ae60;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .material-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .material-info h5 {
            color: #3498db;
            margin: 0 0 10px 0;
        }
        
        .material-info p {
            margin: 5px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 PBR材质识别系统</h1>
            <p>支持10种材料分类，文件名自动识别，下拉菜单选择</p>
        </div>
        
        <div class="enhanced-features">
            <h4>✨ 系统特点</h4>
            <ul class="feature-list">
                <li>支持10种材料分类（wood, metal, plastic, vinyl, paper, silicone, rubber, leather, stone, screen print）</li>
                <li>中英文文件名自动识别</li>
                <li>下拉菜单快速选择</li>
                <li>基于材质数据库的精准参数预测</li>
                <li>置信度提升机制（提升15%-40%）</li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h3>📤 图片上传</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <p>点击或拖拽图片到此处</p>
                    <p style="font-size: 0.9rem; color: #7f8c8d;">支持 JPG, PNG, GIF 格式</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="material-selection">
                    <h4>🔍 选择材料分类（可选，但强烈推荐）</h4>
                    <p style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px;">
                        选择材料分类可以大幅提高识别精准度，如果不选择系统会自动检测
                    </p>
                    
                    <div class="dropdown-container">
                        <label class="dropdown-label">材料分类：</label>
                        <select id="materialDropdown" class="material-dropdown">
                            <option value="">-- 自动检测 --</option>
                        </select>
                    </div>
                    
                    <div id="materialInfo" class="material-info" style="display: none;">
                        <h5>📋 材料信息</h5>
                        <div id="materialDetails"></div>
                    </div>
                </div>
                
                <button id="analyzeBtn" style="width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; margin-top: 20px;">
                    开始分析
                </button>
            </div>
            
            <div class="panel">
                <h3>📊 分析结果</h3>
                <div id="status"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>正在分析图片，请稍候...</p>
                </div>
                <div id="results"></div>
            </div>
        </div>
        
        <div class="panel results-panel">
            <h3>📈 详细参数</h3>
            <div id="detailedResults"></div>
        </div>
    </div>

    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- 引入 Atomm UI (已包含本地 Core 代码和 VueUse) -->
    <script src="https://minio-download.makeblock.com/resource/atomm-ui-umd/dist-browser/atomm-ui.js"></script>

    <script>
        // 全局变量
        let selectedImage = null;
        let selectedFile = null;
        let selectedMaterial = null;
        let autoDetectedMaterial = null;
        let materials = [];
        
        const API_BASE = 'http://localhost:5001';
        
        // 材料分类映射
        const materialMap = {
            'wood': { name: '木材', keywords: ['wood', '木', '木材', 'oak', '橡木', 'pine', '松木'] },
            'metal': { name: '金属', keywords: ['metal', '金属', 'aluminum', '铝', 'steel', '钢', 'iron', '铁', 'copper', '铜'] },
            'plastic': { name: '塑料', keywords: ['plastic', '塑料', 'pvc', 'abs', 'poly'] },
            'vinyl': { name: '乙烯基', keywords: ['vinyl', '乙烯基', 'vinyl_', 'pvc'] },
            'paper': { name: '纸张', keywords: ['paper', '纸张', '纸', 'cardboard', '纸板'] },
            'silicone': { name: '硅胶', keywords: ['silicone', '硅胶', 'silicone_', 'rubber'] },
            'rubber': { name: '橡胶', keywords: ['rubber', '橡胶', 'rubber_', 'latex'] },
            'leather': { name: '皮革', keywords: ['leather', '皮革', 'leather_', 'skin'] },
            'stone': { name: '石材', keywords: ['stone', '石材', 'stone_', 'marble', '大理石', 'granite', '花岗岩'] },
            'screen_print': { name: '丝网印刷', keywords: ['screen_print', '丝网印刷', 'screen', '印刷', 'print'] }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化...');
            loadMaterials();
            setupEventListeners();
        });
        
        // 加载材料信息
        async function loadMaterials() {
            try {
                console.log('正在加载材料信息...');
                const response = await fetch(`${API_BASE}/api/materials/all`);
                const data = await response.json();
                materials = data.materials;
                
                populateDropdown();
                console.log('材料信息加载完成');
            } catch (error) {
                console.error('加载材料信息失败:', error);
                showStatus('无法加载材料信息，将使用基础分析模式', 'info');
            }
        }
        
        // 填充下拉菜单
        function populateDropdown() {
            const dropdown = document.getElementById('materialDropdown');
            
            materials.forEach(material => {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.name} (${material.id})`;
                dropdown.appendChild(option);
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            console.log('设置事件监听器...');
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const materialDropdown = document.getElementById('materialDropdown');
            
            console.log('找到元素:', { uploadArea, fileInput, analyzeBtn, materialDropdown });
            
            // 文件上传
            uploadArea.addEventListener('click', (e) => {
                console.log('点击上传区域');
                e.preventDefault();
                fileInput.click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                console.log('文件选择变化:', e.target.files);
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // 材料选择
            materialDropdown.addEventListener('change', (e) => {
                selectedMaterial = e.target.value;
                updateMaterialInfo();
                if (selectedMaterial) {
                    showStatus(`已选择材料: ${materialMap[selectedMaterial]?.name || selectedMaterial}`, 'success');
                } else {
                    showStatus('已切换到自动检测模式', 'info');
                }
            });
            
            // 分析按钮
            analyzeBtn.addEventListener('click', analyzeImage);
            
            console.log('事件监听器设置完成');
        }
        
        // 更新材料信息显示
        function updateMaterialInfo() {
            const materialInfo = document.getElementById('materialInfo');
            const materialDetails = document.getElementById('materialDetails');
            
            if (selectedMaterial && materialMap[selectedMaterial]) {
                const material = materialMap[selectedMaterial];
                materialDetails.innerHTML = `
                    <p><strong>中文名称:</strong> ${material.name}</p>
                    <p><strong>英文ID:</strong> ${selectedMaterial}</p>
                    <p><strong>关键词:</strong> ${material.keywords.join(', ')}</p>
                `;
                materialInfo.style.display = 'block';
            } else {
                materialInfo.style.display = 'none';
            }
        }
        
        // 处理文件选择
        function handleFileSelect(file) {
            console.log('处理文件:', file);
            
            if (!file.type.startsWith('image/')) {
                showStatus('请选择图片文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result;
                selectedFile = file;
                const uploadArea = document.getElementById('uploadArea');
                
                // 检查文件名是否包含材料信息
                const filename = file.name;
                const detectedInfo = detectMaterialFromFilename(filename);
                
                let statusMessage = '图片上传成功';
                if (detectedInfo) {
                    statusMessage += `，检测到材料: ${detectedInfo.name} (${detectedInfo.id})`;
                    autoDetectedMaterial = detectedInfo.id;
                }
                
                uploadArea.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                    <p style="margin-top: 10px; color: #27ae60;">✓ 图片已上传</p>
                    <p style="margin-top: 5px; font-size: 0.9rem; color: #7f8c8d;">文件名: ${filename}</p>
                    ${detectedInfo ? `<p style="margin-top: 5px; color: #27ae60; font-weight: 600;">🎯 自动识别: ${detectedInfo.name} (${detectedInfo.id})</p>` : ''}
                `;
                showStatus(statusMessage, 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // 从文件名检测材料
        function detectMaterialFromFilename(filename) {
            const nameWithoutExt = filename.toLowerCase().split('.')[0];
            
            // 检查文件名中是否包含关键词
            for (const [id, info] of Object.entries(materialMap)) {
                for (const keyword of info.keywords) {
                    if (nameWithoutExt.includes(keyword)) {
                        return { id, name: info.name };
                    }
                }
            }
            
            return null;
        }
        
        // 分析图片
        async function analyzeImage() {
            if (!selectedImage) {
                showStatus('请先上传图片', 'error');
                return;
            }
            
            showLoading(true);
            showStatus('正在分析图片...', 'info');
            
            try {
                const requestData = {
                    image: selectedImage
                };
                
                // 优先使用手动选择的材料分类
                if (selectedMaterial) {
                    requestData.materialCategory = selectedMaterial;
                    requestData.materialId = selectedMaterial;
                }
                // 如果没有手动选择，使用自动检测的材料分类
                else if (autoDetectedMaterial) {
                    requestData.materialCategory = autoDetectedMaterial;
                    requestData.materialId = autoDetectedMaterial;
                }
                
                // 添加文件名信息
                if (selectedFile) {
                    requestData.filename = selectedFile.name;
                }
                
                const response = await fetch(`${API_BASE}/api/analyze/enhanced`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResults(data.results);
                    showStatus('分析完成！', 'success');
                } else {
                    throw new Error(data.error || '分析失败');
                }
            } catch (error) {
                console.error('分析失败:', error);
                showStatus(`分析失败: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 显示结果
        function showResults(results) {
            const resultsContainer = document.getElementById('results');
            const detailedContainer = document.getElementById('detailedResults');
            
            // 主要结果
            resultsContainer.innerHTML = `
                <div class="result-grid">
                    <div class="result-item">
                        <h4>金属度</h4>
                        <div class="result-value">${(results.metallic * 100).toFixed(1)}%</div>
                        <div class="result-bar">
                            <div class="result-bar-fill" style="width: ${results.metallic * 100}%"></div>
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>粗糙度</h4>
                        <div class="result-value">${(results.roughness * 100).toFixed(1)}%</div>
                        <div class="result-bar">
                            <div class="result-bar-fill" style="width: ${results.roughness * 100}%"></div>
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>透明度</h4>
                        <div class="result-value">${(results.transparency * 100).toFixed(1)}%</div>
                        <div class="result-bar">
                            <div class="result-bar-fill" style="width: ${results.transparency * 100}%"></div>
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>置信度</h4>
                        <div class="result-value">${(results.confidence * 100).toFixed(1)}%</div>
                        <div class="result-bar">
                            <div class="result-bar-fill ${getConfidenceClass(results.confidence)}" style="width: ${results.confidence * 100}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // 详细信息
            let materialInfo = '';
            if (results.material_category) {
                materialInfo = `
                    <div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #27ae60; margin: 0 0 10px 0;">材料信息</h4>
                        <p style="margin: 5px 0;"><strong>分类:</strong> ${results.material_category}</p>
                        ${results.material_name ? `<p style="margin: 5px 0;"><strong>材质:</strong> ${results.material_name}</p>` : ''}
                        <p style="margin: 5px 0;"><strong>分析类型:</strong> ${results.analysis_type}</p>
                        <p style="margin: 5px 0;"><strong>使用材料提示:</strong> ${results.material_hint_used ? '是' : '否'}</p>
                        ${results.auto_detected_from_filename ? `<p style="margin: 5px 0;"><strong>文件名自动识别:</strong> 是</p>` : ''}
                    </div>
                `;
            }
            
            detailedContainer.innerHTML = `
                ${materialInfo}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">基础颜色</h4>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 8px; background: rgb(${results.base_color.join(',')}); border: 2px solid #ecf0f1;"></div>
                            <div>
                                <p style="margin: 5px 0;"><strong>RGB:</strong> ${results.base_color.join(', ')}</p>
                                <p style="margin: 5px 0;"><strong>十六进制:</strong> #${results.base_color.map(c => c.toString(16).padStart(2, '0')).join('')}</p>
                            </div>
                        </div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">法线强度</h4>
                        <div class="result-value">${(results.normalStrength * 100).toFixed(1)}%</div>
                        <div class="result-bar">
                            <div class="result-bar-fill" style="width: ${results.normalStrength * 100}%"></div>
                        </div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">分析时间</h4>
                        <p style="margin: 5px 0;"><strong>时间戳:</strong> ${new Date(results.timestamp).toLocaleString()}</p>
                        <p style="margin: 5px 0;"><strong>分析类型:</strong> ${results.analysis_type}</p>
                    </div>
                </div>
            `;
        }
        
        // 获取置信度样式类
        function getConfidenceClass(confidence) {
            if (confidence >= 0.7) return 'confidence-high';
            if (confidence >= 0.4) return 'confidence-medium';
            return 'confidence-low';
        }
        
        // 显示状态
        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status');
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 显示/隐藏加载状态
        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html> 