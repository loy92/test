<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBRæè´¨è¯†åˆ«ç³»ç»Ÿ - æ‰¹é‡å¤„ç†å¹³å°</title>
    
    <!-- å¼•å…¥ Atomm UI æ ·å¼ -->
    <link rel="stylesheet" href="https://minio-download.makeblock.com/resource/atomm-ui-umd/dist-browser/atomm-ui.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .main-content {
            display: block;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .batch-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .batch-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .batch-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .pbr-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .pbr-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .pbr-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .pbr-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .batch-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .batch-result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .batch-result-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px;
        }
        
        .result-data {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 12px;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .status-ok { background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status-warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin: 10px 0; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary { background: #1890ff; color: white; }
        .btn-success { background: #52c41a; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #fa8c16; color: white; }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ PBRæè´¨è¯†åˆ«ç³»ç»Ÿ</h1>
        <p>æ‰¹é‡å›¾ç‰‡PBRå‚æ•°è¯†åˆ«å¹³å°</p>
    </div>
    
    <div class="container" id="app">

        
        <div class="main-content">
            <!-- æ‰¹é‡æ¨¡å¼ -->
            <div class="panel">
                <h3>ğŸ“š æ‰¹é‡å›¾ç‰‡è¯†åˆ«</h3>
                
                <div class="upload-area" @click="triggerBatchFileInput">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                    <h4>ç‚¹å‡»é€‰æ‹©å¤šå¼ å›¾ç‰‡</h4>
                    <p>æ”¯æŒ JPG, PNG, WebP æ ¼å¼ï¼Œå¯åŒæ—¶é€‰æ‹©å¤šå¼ </p>
                </div>
                
                <input type="file" 
                       ref="batchFileInput" 
                       @change="handleBatchFileSelect"
                       accept="image/*" 
                       multiple
                       style="display: none;">
                
                <!-- æ‰¹é‡å›¾ç‰‡é¢„è§ˆ -->
                <div v-if="selectedImages.length > 0">
                    <h4>å·²é€‰æ‹©å›¾ç‰‡ ({{ selectedImages.length }}å¼ )</h4>
                    <div class="batch-grid">
                        <div v-for="(image, index) in selectedImages" :key="index" class="batch-item">
                            <img :src="image.preview" :alt="image.name">
                            <button class="remove-btn" @click="removeImage(index)">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button @click="startBatchAnalysis" 
                                :disabled="isBatchAnalyzing"
                                class="btn btn-primary">
                            {{ isBatchAnalyzing ? `ğŸ”„ åˆ†æä¸­ (${batchProgress}/${selectedImages.length})` : 'ğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ' }}
                        </button>
                        
                        <button @click="clearAllImages" 
                                :disabled="isBatchAnalyzing"
                                class="btn btn-warning">
                            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
                        </button>
                        
                        <button v-if="batchResults.length > 0"
                                @click="exportBatchResults" 
                                class="btn btn-success">
                            ğŸ“Š å¯¼å‡ºç»“æœ
                        </button>
                        
                        <button @click="forceReset" 
                                class="btn btn-danger">
                            ğŸš¨ å¼ºåˆ¶é‡ç½®çŠ¶æ€
                        </button>
                    </div>
                    
                    <!-- æ‰¹é‡è¿›åº¦ -->
                    <div v-if="isBatchAnalyzing" class="status-warning">
                        <strong>æ‰¹é‡åˆ†æè¿›åº¦:</strong> {{ batchProgress }}/{{ selectedImages.length }} 
                        ({{ Math.round(batchProgress / selectedImages.length * 100) }}%)
                    </div>
                </div>
                
                <!-- æ‰¹é‡ç»“æœæ˜¾ç¤º -->
                <div v-if="batchResults.length > 0">
                    <h4>ğŸ“Š æ‰¹é‡åˆ†æç»“æœ ({{ batchResults.length }}å¼ )</h4>
                    <div class="batch-results">
                        <div v-for="(result, index) in batchResults" :key="index" class="batch-result-item">
                            <img :src="result.image" :alt="result.name">
                            <div class="result-data">
                                <div>
                                    <strong>æ–‡ä»¶å</strong><br>
                                    <span style="font-size: 12px; color: #666;">{{ result.name }}</span>
                                    <div v-if="result.detected_material" style="margin-top: 5px;">
                                        <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #1976d2;">
                                            ğŸ¯ {{ result.detected_material }}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <strong>é‡‘å±åº¦</strong><br>
                                    {{ (result.metallic * 100).toFixed(1) }}%
                                </div>
                                <div>
                                    <strong>ç²—ç³™åº¦</strong><br>
                                    {{ (result.roughness * 100).toFixed(1) }}%
                                </div>
                                <div>
                                    <strong>ç½®ä¿¡åº¦</strong><br>
                                    {{ (result.confidence * 100).toFixed(1) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // æ‰¹é‡å¤„ç†çŠ¶æ€
                    isBatchAnalyzing: false,      // æ‰¹é‡åˆ†æçŠ¶æ€
                    selectedImages: [],           // æ‰¹é‡é€‰æ‹©çš„å›¾ç‰‡
                    batchProgress: 0,             // æ‰¹é‡è¿›åº¦
                    batchResults: [],             // æ‰¹é‡ç»“æœ
                    mounted: false                // æŒ‚è½½çŠ¶æ€
                };
            },
            
            methods: {
                // è§¦å‘æ‰¹é‡æ–‡ä»¶é€‰æ‹©
                triggerBatchFileInput() {
                    this.$refs.batchFileInput.click();
                },
                
                // å¤„ç†æ‰¹é‡æ–‡ä»¶é€‰æ‹©
                handleBatchFileSelect(event) {
                    const files = Array.from(event.target.files);
                    
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.selectedImages.push({
                                    name: file.name,
                                    file: file,
                                    preview: e.target.result
                                });
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    
                    console.log(`âœ… æ‰¹é‡é€‰æ‹©äº† ${files.length} å¼ å›¾ç‰‡`);
                },
                
                // ç§»é™¤å•å¼ å›¾ç‰‡
                removeImage(index) {
                    this.selectedImages.splice(index, 1);
                    console.log(`ğŸ—‘ï¸ ç§»é™¤äº†ç¬¬ ${index + 1} å¼ å›¾ç‰‡`);
                },
                
                // æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
                clearAllImages() {
                    this.selectedImages = [];
                    this.batchResults = [];
                    this.batchProgress = 0;
                    console.log('ğŸ—‘ï¸ æ¸…ç©ºäº†æ‰€æœ‰å›¾ç‰‡');
                },
                

                
                // å¼€å§‹æ‰¹é‡åˆ†æ
                async startBatchAnalysis() {
                    if (this.selectedImages.length === 0) {
                        alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                        return;
                    }
                    
                    console.log(`ğŸš€ å¼€å§‹æ‰¹é‡åˆ†æ ${this.selectedImages.length} å¼ å›¾ç‰‡`);
                    this.isBatchAnalyzing = true;
                    this.batchProgress = 0;
                    this.batchResults = [];
                    
                    try {
                        for (let i = 0; i < this.selectedImages.length; i++) {
                            const image = this.selectedImages[i];
                            console.log(`ğŸ”„ åˆ†æç¬¬ ${i + 1} å¼ å›¾ç‰‡: ${image.name}`);
                            
                            try {
                                // è°ƒç”¨çœŸå®API
                                const base64 = image.preview.split(',')[1];
                                const response = await fetch('http://localhost:5001/api/analyze/enhanced', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        image: base64,
                                        filename: image.name  // ä¼ é€’æ–‡ä»¶åç”¨äºææ–™è¯†åˆ«
                                    })
                                });
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.success && data.results) {
                                        const result = {
                                            name: image.name,
                                            image: image.preview,
                                            metallic: data.results.metallic,
                                            roughness: data.results.roughness,
                                            confidence: data.results.confidence,
                                            // ä»åç«¯ç»“æœä¸­è·å–ææ–™ç±»å‹ä¿¡æ¯
                                            detected_material: data.results.detected_material || data.results.material_type || '',
                                            auto_detected: data.results.auto_detected_from_filename || false,
                                            timestamp: data.results.timestamp || new Date().toISOString()
                                        };
                                        this.batchResults.push(result);
                                        console.log(`âœ… ç¬¬ ${i + 1} å¼ å›¾ç‰‡åˆ†æå®Œæˆï¼Œæ£€æµ‹åˆ°ææ–™: ${result.detected_material}`);
                                    } else {
                                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                                    }
                                } else {
                                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                                }
                                
                            } catch (apiError) {
                                console.error(`âŒ åˆ†æå›¾ç‰‡ ${image.name} å¤±è´¥:`, apiError);
                                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                                const result = {
                                    name: image.name,
                                    image: image.preview,
                                    metallic: Math.random() * 0.8 + 0.1,
                                    roughness: Math.random() * 0.6 + 0.2,
                                    confidence: Math.random() * 0.3 + 0.7,
                                    detected_material: 'åˆ†æå¤±è´¥',
                                    auto_detected: false,
                                    timestamp: new Date().toISOString()
                                };
                                this.batchResults.push(result);
                            }
                            
                            this.batchProgress = i + 1;
                        }
                        
                        console.log('ğŸ‰ æ‰¹é‡åˆ†æå…¨éƒ¨å®Œæˆï¼');
                        
                    } catch (error) {
                        console.error('âŒ æ‰¹é‡åˆ†æå‡ºé”™:', error);
                        alert('æ‰¹é‡åˆ†æå¤±è´¥: ' + error.message);
                    } finally {
                        this.isBatchAnalyzing = false;
                        console.log('ğŸ æ‰¹é‡åˆ†æfinally: isBatchAnalyzing = false');
                    }
                },
                
                // å¯¼å‡ºæ‰¹é‡ç»“æœ
                exportBatchResults() {
                    const results = this.batchResults.map(result => ({
                        å›¾ç‰‡åç§°: result.name,
                        æ£€æµ‹ææ–™: result.detected_material || 'æœªè¯†åˆ«',
                        è‡ªåŠ¨æ£€æµ‹: result.auto_detected ? 'æ˜¯' : 'å¦',
                        é‡‘å±åº¦: (result.metallic * 100).toFixed(1) + '%',
                        ç²—ç³™åº¦: (result.roughness * 100).toFixed(1) + '%',
                        ç½®ä¿¡åº¦: (result.confidence * 100).toFixed(1) + '%',
                        åˆ†ææ—¶é—´: result.timestamp
                    }));
                    
                    const csv = this.convertToCSV(results);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `PBRåˆ†æç»“æœ_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    
                    console.log('ğŸ“Š æ‰¹é‡ç»“æœå·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶');
                },
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                convertToCSV(data) {
                    if (data.length === 0) return '';
                    
                    const headers = Object.keys(data[0]);
                    const csv = [
                        headers.join(','),
                        ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
                    ].join('\n');
                    
                    return '\ufeff' + csv; // æ·»åŠ BOMä»¥ç¡®ä¿Excelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
                },
                
                // å¼ºåˆ¶é‡ç½®çŠ¶æ€
                forceReset() {
                    console.log('ğŸš¨ å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€');
                    this.isBatchAnalyzing = false;
                    this.selectedImages = [];
                    this.batchResults = [];
                    this.batchProgress = 0;
                    alert('âœ… çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®ï¼');
                },
                
            },
            
            // ç»„ä»¶æŒ‚è½½æ—¶
            mounted() {
                console.log('ğŸš€ PBRæ‰¹é‡è¯†åˆ«ç³»ç»Ÿå·²æŒ‚è½½');
                this.mounted = true;
                
                // å¼ºåˆ¶ç¡®ä¿åˆ†æçŠ¶æ€ä¸ºfalse
                this.isBatchAnalyzing = false;
                
                console.log('âœ… æ‰¹é‡è¯†åˆ«ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }
        }).mount('#app');
    </script>
</body>
</html>